suite: test external secrets
release:
  name: platform-external-secrets
  namespace: platform
templates:
  - external-secrets.yaml
tests:
  - it: should render external secrets
    set:
      externalSecrets:
        - metadata:
            name: platform-secrets
          spec:
            refreshInterval: 1h
            secretStoreRef:
              name: should-be-overwritten
            data:
              - secretKey: platform-token
                remoteRef:
                  key: clusters/test-cluster/platform
                  property: token
        - metadata:
            name: registry-credentials
          spec:
            dataFrom:
              - extract:
                  key: clusters/test-cluster/registry
    asserts:
      - matchSnapshot: {}
      - equal:
          path: spec.secretStoreRef.name
          value: platform-external-secrets-vault
          documentIndex: 0
      - equal:
          path: spec.secretStoreRef.name
          value: platform-external-secrets-vault
          documentIndex: 1
