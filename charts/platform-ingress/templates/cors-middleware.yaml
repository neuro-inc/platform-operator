apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: {{ .Release.Name }}-cors
  labels:
    {{- include "platform.labels.common" . | nindent 4 }}
    service: traefik
spec:
  headers:
    accessControlAllowCredentials: true
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - HEAD
      - OPTIONS
    accessControlAllowHeaders:
      - authorization
      - accept
      - accept-language
      - content-language
      - upgrade
      - connection
      - sec-websocket-accept
      - sec-websocket-protocol
      - sec-websocket-version
      - sec-websocket-extensions
      - sec-websocket-key
      - sec-websocket-key1
      - last-event-id
      - content-type
      - x-requested-with
      - x-amz-content-sha256
      - x-amz-security-token
      - x-amz-date
      - x-amz-user-agent
      - amz-sdk-invocation-id
      - amz-sdk-request
    {{- with .Values.cors.originList }}
    accessControlAllowOriginList:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    accessControlAllowOriginListRegex:
      - https:\/\/[a-zA-Z0-9_-]+\.jobs\.{{ include "platform.clusterDnsName" . | regexQuoteMeta }}
      - https:\/\/[a-zA-Z0-9_-]+\.apps\.{{ include "platform.clusterDnsName" . | regexQuoteMeta }}
      {{- with .Values.cors.originListRegex }}
      {{- toYaml . | nindent 6 }}
      {{- end }}
    accessControlMaxAge: 100
    addVaryHeader: true
