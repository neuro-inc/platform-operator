suite: test external secrets
release:
  name: platform
  namespace: platform
templates:
  - external-secrets.yaml
values:
  - common-values.yaml
tests:
  - it: should render external secrets
    set:
      externalSecrets:
        - metadata:
            name: platform-secrets
          spec:
            refreshInterval: 1h
            secretStoreRef:
              name: should-be-overwritten
            data:
              - secretKey: platform-token
                remoteRef:
                  key: clusters/test-cluster/platform
                  property: token
        - metadata:
            name: registry-credentials
          spec:
            dataFrom:
              - extract:
                  key: clusters/test-cluster/registry
    asserts:
      - matchSnapshot: {}
      - equal:
          path: spec.secretStoreRef.name
          value: platform-vault-secret-store
          documentIndex: 0
      - equal:
          path: spec.secretStoreRef.name
          value: platform-vault-secret-store
          documentIndex: 1
  - it: should fail without syncWave
    set:
      applications:
        externalSecrets:
          syncWave: null
      externalSecrets:
        - metadata:
            name: platform-secrets
          spec:
            dataFrom:
              - extract:
                  key: clusters/test-cluster/platform
    asserts:
      - failedTemplate:
          errorMessage: applications.externalSecrets.syncWave is required
